<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס הזמנה</title>
    <style>
        :root {
            --primary-color: #005A9C; --secondary-color: #00A9E0; --background-color: #f8f9fa;
            --form-background: #ffffff; --text-color: #333333; --border-color: #dee2e6;
            --border-radius: 8px; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--background-color); margin: 0;
            padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1200px; align-items: flex-start; }
        .form-container { background-color: var(--form-background); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); flex: 1; max-width: 650px; }
        .image-container { flex-basis: 45%; position: sticky; top: 20px; display: none; }
        #pharmacyImage { width: 100%; height: auto; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        h1, h2 { color: var(--primary-color); text-align: center; margin-bottom: 25px; }
        #orderForm fieldset { border: none; padding: 0; margin: 0 0 20px 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-color); font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        .product { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .product:last-child { border-bottom: none; }
        .product label { flex: 1; margin: 0 15px; font-weight: normal; }
        .product input[type="number"] { width: 80px; text-align: center; }
        #summary-container { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        #summary-container h3 { text-align: center; margin-top: 0; margin-bottom: 20px; color: var(--primary-color); }
        .summary-row { display: flex; justify-content: space-between; font-size: 1.1em; padding: 8px 0; }
        .summary-row.total { font-weight: bold; font-size: 1.3em; color: var(--primary-color); border-top: 2px solid var(--border-color); margin-top: 10px; padding-top: 10px; }
        button[type="submit"] { background-color: var(--secondary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 1.2em; font-weight: bold; width: 100%; margin-top: 20px; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    </style>
</head>
<body>

<main class="main-container">
    <div class="form-container">
        <h1>טופס הזמנה</h1>
        
        <form id="orderForm" novalidate>
            <fieldset>
                <legend><h2>פרטי המזמין</h2></legend>
                <div class="form-group">
                    <label for="customerName">שם מלא:</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="placeType">סוג העסק:</label>
                    <select id="placeType" required>
                        <option value="" disabled selected>-- יש לבחור --</option>
                        <option value="pharmacy">בית מרקחת</option>
                        <option value="future_pharmacy">בית מרקחת - רוקחים עתיד</option>
                        <option value="shrem_pharmacy">בית מרקחת - שרמ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="placeName">שם בית המרקחת:</label>
                    <input type="text" id="placeName" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">מספר טלפון:</label>
                    <input type="tel" id="phoneNumber" required>
                </div>
            </fieldset>

            <fieldset>
                <legend><h2>רשימת מוצרים</h2></legend>
                <small>(המחירים אינם כוללים מע"מ)</small>
                <div id="productList" style="margin-top: 10px;"></div>
            </fieldset>

            <div id="summary-container">
                <h3>סיכום הזמנה</h3>
                <div class="summary-row">
                    <span>סכום ביניים:</span>
                    <span id="subtotal">0.00 ₪</span>
                </div>
                <div class="summary-row">
                    <span>מע"מ (17%):</span>
                    <span id="vat">0.00 ₪</span>
                </div>
                <div class="summary-row total">
                    <span>סה"כ לתשלום:</span>
                    <span id="total">0.00 ₪</span>
                </div>
            </div>
            <button type="submit" id="submitBtn" disabled>שלח הזמנה</button>
        </form>
    </div>

    <aside class="image-container">
        <img id="pharmacyImage" src="" alt="תמונת בית מרקחת">
    </aside>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const VAT_RATE = 0.18; // מע"מ 17%
        const productData = {
            pharmacy: [
                {id: 'quantity14', name: 'בדיקה לאבחון שפעת + קורונה', sku: '7290019098546', price: 24},
                {id: 'quantity1', name: 'פורמט עט - NO STEP בדיקות דלקת גרון', sku: '7290013882080', price: 19.90},
                {id: 'quantity2', name: 'STREP T בדיקה לדלקת גרון', sku: '7290008123723', price: 13.90},
                {id: 'quantity3', name: 'A + B בדיקה לשפעת - פורמט עט', sku: '7290013882165', price: 19.90},
                {id: 'quantity4', name: 'בדיקת הריון 1', sku: '7290013882097', price: 5.20},
                {id: 'quantity5', name: 'בדיקת הריון 2', sku: '7290013882103', price: 6.50},
                {id: 'quantity13', name: '"בדיקת הריון "בשעה טובה', sku: '7290013882172-7', price: 18.90},
                {id: 'quantity6', name: 'בדיקה לדלקת בשתן', sku: '7290013882035', price: 13.90},
                {id: 'quantity7', name: 'בדיקת קנדידה וגינאלית', sku: '7290013882042', price: 17.20},
                {id: 'quantity8', name: 'בדיקת סמים 8 פרמטרים', sku: '7290013882127', price: 33.90},
                {id: 'quantity9', name: 'בדיקה לגילוי דם סמוי בצואה', sku: '7290013882066', price: 24.90},
                {id: 'quantity10', name: 'בדיקה לאבחון וירוס הקורונה', sku: '7290019098409', price: 30.00},
                {id: 'quantity11', name: 'בדיקת ביוץ - 7 באריזה', sku: '7290013882028-7', price: 21.00},
                {id: 'quantity12', name: '"בדיקת ביוץ "בשעה טובה', sku: '7290013882073-12', price: 29.90},
            ],
            future_pharmacy: [
                {id: 'quantity14', name: 'בדיקה לאבחון שפעת + קורונה', sku: '7290019098546', price: 24},
                {id: 'quantity10', name: 'בדיקה לאבחון וירוס הקורונה', sku: '7290019098409', price: 30.00},
                {id: 'quantity1', name: 'פורמט עט - NO STEP בדיקות דלקת גרון', sku: '7290013882080', price: 19.90},
                {id: 'quantity2', name: 'STREP T בדיקה לדלקת גרון', sku: '7290008123723', price: 13.90},
                {id: 'quantity3', name: 'A + B בדיקה לשפעת - פורמט עט', sku: '7290013882165', price: 19.90},
                {id: 'quantity4', name: 'בדיקת הריון 1 - רוקחים עתיד', sku: '7290013882134', price: 2.90},
                {id: 'quantity5', name: 'בדיקת הריון 2 - רוקחים עתיד', sku: '7290013882196', price: 5.20},
                {id: 'quantity6', name: '"בדיקת הריון "בשעה טובה', sku: '7290013882172-7', price: 18.90},
                {id: 'quantity7', name: '"בדיקת ביוץ "בשעה טובה', sku: '7290013882073-12', price: 29.90},
                {id: 'quantity8', name: 'בדיקת ביוץ 7 באריזה', sku: '7290013882028-7', price: 21.00},
                {id: 'quantity9', name: 'בדיקה לדלקת בשתן', sku: '7290013882035', price: 13.90},
                {id: 'quantity11', name: 'בדיקת קנדידה וגינאלית', sku: '7290013882042', price: 17.20},
                {id: 'quantity12', name: 'בדיקה לגילוי דם סמוי בצואה', sku: '7290013882066', price: 24.90},
                {id: 'quantity13', name: 'בדיקת סמים 8 פרמטרים', sku: '7290013882127', price: 33.90}
            ],
            shrem_pharmacy: [
                // Assuming the same product list as 'pharmacy' for this example
                {id: 'quantity14', name: 'בדיקה לאבחון שפעת + קורונה', sku: '7290019098546', price: 24},
                {id: 'quantity1', name: 'פורמט עט - NO STEP בדיקות דלקת גרון', sku: '7290013882080', price: 19.90},
                {id: 'quantity2', name: 'STREP T בדיקה לדלקת גרון', sku: '7290008123723', price: 13.90},
                {id: 'quantity3', name: 'A + B בדיקה לשפעת - פורמט עט', sku: '7290013882165', price: 19.90},
                {id: 'quantity4', name: 'בדיקת הריון 1', sku: '7290013882097', price: 5.20},
                {id: 'quantity5', name: 'בדיקת הריון 2', sku: '7290013882103', price: 6.50},
                {id: 'quantity13', name: '"בדיקת הריון "בשעה טובה', sku: '7290013882172-7', price: 18.90},
                {id: 'quantity6', name: 'בדיקה לדלקת בשתן', sku: '7290013882035', price: 13.90},
                {id: 'quantity7', name: 'בדיקת קנדידה וגינאלית', sku: '7290013882042', price: 17.20},
                {id: 'quantity8', name: 'בדיקת סמים 8 פרמטרים', sku: '7290013882127', price: 33.90},
                {id: 'quantity9', name: 'בדיקה לגילוי דם סמוי בצואה', sku: '7290013882066', price: 24.90},
                {id: 'quantity10', name: 'בדיקה לאבחון וירוס הקורונה', sku: '7290019098409', price: 30.00},
                {id: 'quantity11', name: 'בדיקת ביוץ - 7 באריזה', sku: '7290013882028-7', price: 21.00},
                {id: 'quantity12', name: '"בדיקת ביוץ "בשעה טובה', sku: '7290013882073-12', price: 29.90},
            ]
        };
        
          const form = document.getElementById('orderForm');
        const placeTypeSelect = document.getElementById('placeType');
        const productListDiv = document.getElementById('productList');
        const submitBtn = document.getElementById('submitBtn');
        const imageContainer = document.querySelector('.image-container');
        const pharmacyImage = document.getElementById('pharmacyImage');
        // --- אלמנטים חדשים לסיכום ---
        const subtotalEl = document.getElementById('subtotal');
        const vatEl = document.getElementById('vat');
        const totalEl = document.getElementById('total');
        // -------------------------

        function populateProducts() {
            const placeType = placeTypeSelect.value;
            productListDiv.innerHTML = '';
            
            if (placeType && productData[placeType]) {
                productData[placeType].forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product';
                    productDiv.innerHTML = `
                        <label for="${product.id}">${product.name}</label>
                        <input type="number" id="${product.id}" class="product-quantity" min="0" value="0" data-price="${product.price}">
                    `;
                    productListDiv.appendChild(productDiv);
                });
            }
            calculateTotal();
            validateForm();
        }
        
        // --- פונקציית חישוב המחיר (הוחזרה) ---
        function calculateTotal() {
            let subtotal = 0;
            const productInputs = productListDiv.querySelectorAll('.product-quantity');

            productInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                subtotal += quantity * price;
            });
            
            const vat = subtotal * VAT_RATE;
            const total = subtotal + vat;
            
            subtotalEl.textContent = `${subtotal.toFixed(2)} ₪`;
            vatEl.textContent = `${vat.toFixed(2)} ₪`;
            totalEl.textContent = `${total.toFixed(2)} ₪`;
            
            validateForm();
        }

        function updateImage() {
            const placeType = placeTypeSelect.value;
            const images = {
                pharmacy: 'טופס הזמנה מרץ פרטיים.jpg',
                future_pharmacy: 'טופס הזמנה 03-25 רוקחים עתיד.png',
                shrem_pharmacy: 'טופס הזמנה מרץ פרטיים.jpg'
            };

            if (placeType && images[placeType]) {
                pharmacyImage.src = images[placeType];
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
        }

        function hasProductsSelected() {
            return Array.from(productListDiv.querySelectorAll('.product-quantity')).some(input => parseInt(input.value) > 0);
        }

        function validateForm() {
            submitBtn.disabled = !(form.checkValidity() && hasProductsSelected());
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'שולח...';

            const orderData = {
                customerName: document.getElementById('customerName').value,
                placeType: placeTypeSelect.value,
                placeName: document.getElementById('placeName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                products: [],
                summary: {
                    subtotal: subtotalEl.textContent,
                    vat: vatEl.textContent,
                    total: totalEl.textContent
                }
            };

            const selectedPlaceType = placeTypeSelect.value;
            productData[selectedPlaceType].forEach(product => {
                const quantityInput = document.getElementById(product.id);
                if (quantityInput && parseInt(quantityInput.value) > 0) {
                    orderData.products.push({
                        name: product.name,
                        sku: product.sku,
                        quantity: parseInt(quantityInput.value)
                    });
                }
            });

            try {
                const apiUrl = 'https://bmtbiomarketingopen.pythonanywhere.com/api/submit_order'; 
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert('ההזמנה נקלטה בהצלחה!');
                form.reset();
                populateProducts();

            } catch (error) {
                alert(`שגיאה בשליחת ההזמנה: ${error.message}`);
            } finally {
                submitBtn.textContent = 'שלח הזמנה';
                validateForm();
            }
        }

        placeTypeSelect.addEventListener('change', () => {
            populateProducts();
            updateImage();
        });
        
        // --- מאזין חדש לחישוב המחירים ---
        productListDiv.addEventListener('input', calculateTotal);
        
        form.addEventListener('input', validateForm);
        form.addEventListener('submit', handleFormSubmit);
    });
</script>

</body>
</html>
